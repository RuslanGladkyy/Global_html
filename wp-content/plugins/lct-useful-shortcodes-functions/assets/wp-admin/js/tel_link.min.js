var lcttellinkShortcodeUI;!function(t,e){var o=window.lcttellinkShortcodeUI={models:{},collections:{},views:{},utils:{},strings:{}};o.models.ShortcodeAttribute=Backbone.Model.extend({defaults:{attr:"",label:"",type:"",section:"",description:"","default":"",value:""}}),o.models.ShortcodeAttributes=Backbone.Collection.extend({model:o.models.ShortcodeAttribute,clone:function(){return new this.constructor(_.map(this.models,function(t){return t.clone()}))}}),o.models.Shortcode=Backbone.Model.extend({defaults:{label:"",shortcode_tag:"",action_tag:"",attrs:o.models.ShortcodeAttributes},set:function(t,e){return void 0===t.attrs||t.attrs instanceof o.models.ShortcodeAttributes||(_.each(t.attrs,function(t){void 0!=t["default"]&&(t.value=t["default"])}),t.attrs=new o.models.ShortcodeAttributes(t.attrs)),Backbone.Model.prototype.set.call(this,t,e)},toJSON:function(t){return t=Backbone.Model.prototype.toJSON.call(this,t),void 0!==t.attrs&&t.attrs instanceof o.models.ShortcodeAttributes&&(t.attrs=t.attrs.toJSON()),t},clone:function(){var t=Backbone.Model.prototype.clone.call(this);return t.set("attrs",t.get("attrs").clone()),t},formatShortcode:function(){var t,e,o=[];return this.get("attrs").each(function(t){var n=t.get("value"),i=t.get("type"),r=t.get("default");(!n||n.length<1)&&"checkbox"!=i||"checkbox"==i&&"true"!=r&&!n||("content"===t.get("attr")?e=t.get("value"):o.push(t.get("attr")+'="'+n+'"'))}),t="[{{ shortcode }} {{ attributes }}]",e&&e.length>0&&(t+="{{ content }}[/{{ shortcode }}]"),t=t.replace(/{{ shortcode }}/g,this.get("shortcode_tag")),t=t.replace(/{{ attributes }}/g,o.join(" ")),t=t.replace(/{{ content }}/g,e)},validate:function(t){var e=[],n=t.attrs.findWhere({attr:"phone"});return n.get("value")||e.push({phone:o.strings.pleaseEnterAPhone}),e.length?e:null}}),o.collections.Shortcodes=Backbone.Collection.extend({model:o.models.Shortcode}),o.views.editShortcodeForm=wp.Backbone.View.extend({el:"#lct_tel_link-shortcode-ui-container",template:wp.template("lct-shortcode-default-edit-form"),hasAdvancedValue:!1,events:{"click #lct_tel_link-update-shortcode":"insertShortcode","click #lct_tel_link-insert-shortcode":"insertShortcode","click #lct_tel_link-cancel-shortcode":"cancelShortcode"},initialize:function(){_.bindAll(this,"beforeRender","render","afterRender");var t=this;this.render=_.wrap(this.render,function(e){return t.beforeRender(),e(),t.afterRender(),t}),this.model.get("attrs").each(function(e){switch(e.get("section")){case"required":t.views.add(".lct-edit-shortcode-form-required-attrs",new o.views.editAttributeField({model:e,parent:t}));break;case"standard":t.views.add(".lct-edit-shortcode-form-standard-attrs",new o.views.editAttributeField({model:e,parent:t}));break;default:t.views.add(".lct-edit-shortcode-form-advanced-attrs",new o.views.editAttributeField({model:e,parent:t})),t.hasAdvancedVal||(t.hasAdvancedVal=""!==e.get("value"))}}),this.listenTo(this.model,"change",this.render)},beforeRender:function(){},afterRender:function(){lct_initialize_tooltips(),e("#lct_tel_link-insert-shortcode").toggle("insert"==this.options.viewMode),e("#lct_tel_link-update-shortcode").toggle("insert"!=this.options.viewMode),e("#lct-edit-shortcode-form-advanced-attrs").toggle(this.hasAdvancedVal)},insertShortcode:function(t){var e=this.model.isValid({validate:!0});e?(send_to_editor(this.model.formatShortcode()),tb_remove(),this.dispose()):_.each(this.model.validationError,function(t){_.each(t,function(t,e){alert(t)})})},cancelShortcode:function(t){tb_remove(),this.dispose()},dispose:function(){this.remove(),e("#lct_tel_link-shortcode-ui-wrap").append('<div id="lct_tel_link-shortcode-ui-container"></div>')}}),o.views.editAttributeField=Backbone.View.extend({tagName:"div",initialize:function(t){this.parent=t.parent},events:{'keyup  input[type="text"]':"updateValue","keyup  textarea":"updateValue","change select":"updateValue","change #lct-shortcode-attr-action":"updateAction","change input[type=checkbox]":"updateCheckbox","change input[type=radio]":"updateValue","change input[type=email]":"updateValue","change input[type=number]":"updateValue","change input[type=date]":"updateValue","change input[type=url]":"updateValue"},render:function(){return this.template=wp.media.template("lct-shortcode-ui-field-"+this.model.get("type")),this.$el.html(this.template(this.model.toJSON()))},updateValue:function(t){var o=e(t.target);this.model.set("value",o.val())},updateCheckbox:function(t){var o=e(t.target),n=o.prop("checked");this.model.set("value",n)},updateAction:function(t){var n=e(t.target),i=n.val();this.model.set("value",i);var r=this.parent.model,a=o.shortcodes.findWhere({shortcode_tag:"lct_tel_link",action_tag:i}),d=r.get("attrs");a.get("attrs").each(function(t){var e=t.get("attr"),o=d.findWhere({attr:e});if("undefined"!=typeof o){var n=o.get("attr");if(e==n){var i=o.get("value");t.set("value",String(i))}}}),e(this.parent.el).empty();var c=this.parent.options.viewMode;this.parent.dispose(),this.parent.model.set(a),lcttellinkShortcodeUI=new o.views.editShortcodeForm({model:a,viewMode:c}),lcttellinkShortcodeUI.render()}}),o.utils.shortcodeViewConstructor={initialize:function(t){this.shortcodeModel=this.getShortcodeModel(this.shortcode)},getShortcodeModel:function(t){var e="undefined"!=typeof t.attrs.named.action?t.attrs.named.action:"",n=o.shortcodes.findWhere({action_tag:e});if(n){var i=n.clone();return i.get("attrs").each(function(e){e.get("attr")in t.attrs.named&&e.set("value",t.attrs.named[e.get("attr")]),"content"===e.get("attr")&&"content"in t&&e.set("value",t.content)}),i}},getContent:function(){return this.content||this.fetch(),this.content},fetch:function(){var t=this;if(!this.fetching){this.fetching=!0;var o,n=this.shortcodeModel.get("attrs").findWhere({attr:"id"}),i=n.get("value");o={action:"lct_do_shortcode",post_id:e("#post_ID").val(),form_id:i,shortcode:this.shortcodeModel.formatShortcode(),nonce:lctShortcodeUIData.previewNonce},e.post(ajaxurl,o).done(function(e){t.content=e}).fail(function(){t.content='<span class="lct_shortcode_ui_error">'+lctShortcodeUIData.strings.errorLoadingPreview+"</span>"}).always(function(){delete t.fetching,t.render()})}},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>')},View:{overlay:!0,shortcodeHTML:!1,setContent:function(t,o){this.getNodes(function(n,i,r){var a="wrap"===o||"replace"===o?i:r,d=t;_.isString(d)&&(d=n.dom.createFragment(d)),"replace"===o?n.dom.replace(d,a):"remove"===o?(i.parentNode.insertBefore(d,i.nextSibling),e(i).remove()):(a.innerHTML="",a.appendChild(d))})},initialize:function(t){var e="undefined"!=typeof t.shortcode.attrs.named.action?t.shortcode.attrs.named.action:"",n=o.shortcodes.findWhere({action_tag:e});if(!n)return this.shortcodeHTML=decodeURIComponent(t.encodedText),void(this.shortcode=!1);var i=n.clone();i.get("attrs").each(function(e){e.get("attr")in t.shortcode.attrs.named&&e.set("value",t.shortcode.attrs.named[e.get("attr")]),"content"===e.get("attr")&&"content"in t.shortcode&&e.set("value",t.shortcode.content)}),this.shortcode=i},loadingPlaceholder:function(){return'<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>'},getEditors:function(t){var e=[];return _.each(tinymce.editors,function(o){o.plugins.wpview&&(t&&t(o),e.push(o))},this),e},getNodes:function(t){var o=[],n=this;return this.getEditors(function(i){e(i.getBody()).find('[data-wpview-text="'+n.encodedText+'"]').each(function(n,r){t&&t(i,r,e(r).find(".wpview-content").get(0)),o.push(r)})}),o},setIframes:function(t){var o=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;return-1===t.indexOf("<script")?(this.shortcodeHTML=t,void this.render()):void this.getNodes(function(n,i,r){var a,d,c,s,l=n.dom,h="",u=n.getBody().className||"";r.innerHTML="";var p="";wp.mce.views.sandboxStyles?h=wp.mce.views.sandboxStyles:(tinymce.each(l.$('link[rel="stylesheet"]',n.getDoc().head),function(t){t.href&&-1===t.href.indexOf("skins/lightgray/content.min.css")&&-1===t.href.indexOf("skins/wordpress/wp-content.css")&&(h+=l.getOuterHTML(t)+"\n")}),wp.mce.views.sandboxStyles=h),setTimeout(function(){if(a=l.add(r,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",id:"lct_tel_link-shortcode-preview-"+(new Date).getTime(),allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}}),d=a.contentWindow.document,d.open(),d.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+p+h+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+u+'">'+t+"</body></html>"),d.close(),s=function(){a.contentWindow&&e(a).height(e(d.body).height())},o)new o(_.debounce(function(){s()},100)).observe(d.body,{attributes:!0,childList:!0,subtree:!0});else for(c=1;6>c;c++)setTimeout(s,700*c);s(),n.on("wp-body-class-change",function(){d.body.className=n.getBody().className})},50)})},getHtml:function(){if(!this.shortcode)return void this.setContent(this.shortcodeHTML,"remove");var t;if(!1===this.shortcodeHTML){var o=this.shortcode.get("attrs").findWhere({attr:"id"}),n=o.get("value");t={action:"lct_do_shortcode",post_id:e("#post_ID").val(),form_id:n,shortcode:this.shortcode.formatShortcode(),nonce:lctShortcodeUIData.previewNonce},e.post(ajaxurl,t,e.proxy(this.setIframes,this))}return this.shortcodeHTML}},edit:function(t){var n;if("object"==typeof t&&(t=decodeURIComponent(jQuery(t).attr("data-wpview-text"))),n=wp.shortcode.next("lct_tel_link",t)){var i=n.shortcode.attrs.named.action?n.shortcode.attrs.named.action:"",r=o.shortcodes.findWhere({shortcode_tag:n.shortcode.tag,action_tag:i});if(!r)return;var a=r.clone();_.each(n.shortcode.attrs.named,function(t,e){attr=a.get("attrs").findWhere({attr:e}),attr&&attr.set("value",t)});var d=a.get("attrs").findWhere({attr:"id"}),c=d.get("value");e("#add_lct_tel_link_id").val(c),lcttellinkShortcodeUI=new o.views.editShortcodeForm({model:a,viewMode:"update"}),lcttellinkShortcodeUI.render(),e("#lct_tel_link-insert-shortcode").hide(),e("#lct_tel_link-update-shortcode").show(),tb_show("Edit Tel Link","#TB_inline?inlineId=select_lct_tel_link&width=753&height=686","")}}},e(document).ready(function(){o.strings=lctShortcodeUIData.strings,o.shortcodes=new o.collections.Shortcodes(lctShortcodeUIData.shortcodes),lctShortcodeUIData.previewDisabled||"undefined"==typeof wp.mce||wp.mce.views.register("lct_tel_link",e.extend(!0,{},o.utils.shortcodeViewConstructor)),e(document).on("click",".lct_tel_link_media_link",function(){o.shortcodes=new o.collections.Shortcodes(lctShortcodeUIData.shortcodes);var t=o.shortcodes.findWhere({shortcode_tag:"lct_tel_link",action_tag:""});lcttellinkShortcodeUI=new o.views.editShortcodeForm({model:t,viewMode:"insert"}),lcttellinkShortcodeUI.render(),tb_show("Insert a Tel Link","#TB_inline?inlineId=select_lct_tel_link&width=753&height=686","")})})}(window.lctShortcodeUI=window.lctShortcodeUI||{},jQuery);